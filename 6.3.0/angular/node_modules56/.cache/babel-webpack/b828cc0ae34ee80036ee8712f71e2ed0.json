{"ast":null,"code":"/**\r\n * DevExtreme (esm/ui/pivot_grid/local_store.js)\r\n * Version: 21.1.3\r\n * Build date: Tue May 18 2021\r\n *\r\n * Copyright (c) 2012 - 2021 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\nimport { when, Deferred } from \"../../core/utils/deferred\";\nimport dataUtils from \"../../data/utils\";\nimport dataQuery from \"../../data/query\";\nimport dateSerialization from \"../../core/utils/date_serialization\";\nimport { DataSource } from \"../../data/data_source/data_source\";\nimport CustomStore from \"../../data/custom_store\";\nimport { compileGetter, toComparable } from \"../../core/utils/data\";\nimport Class from \"../../core/class\";\nimport { noop } from \"../../core/utils/common\";\nimport { isNumeric, isDefined, isString } from \"../../core/utils/type\";\nimport { each } from \"../../core/utils/iterator\";\nimport { getFiltersByPath, setFieldProperty, setDefaultFieldValueFormatting, storeDrillDownMixin, discoverObjectFields } from \"./ui.pivot_grid.utils\";\nimport ArrayStore from \"../../data/array_store\";\nvar PATH_DELIMETER = \"/./\";\nexport var LocalStore = Class.inherit(function () {\n  var DATE_INTERVAL_SELECTORS = {\n    year: function year(date) {\n      return date && date.getFullYear();\n    },\n    quarter: function quarter(date) {\n      return date && Math.floor(date.getMonth() / 3) + 1;\n    },\n    month: function month(date) {\n      return date && date.getMonth() + 1;\n    },\n    day: function day(date) {\n      return date && date.getDate();\n    },\n    dayOfWeek: function dayOfWeek(date) {\n      return date && date.getDay();\n    }\n  };\n\n  function getDataSelector(dataField) {\n    return -1 !== dataField.indexOf(\".\") ? compileGetter(dataField) : function (data) {\n      return data[dataField];\n    };\n  }\n\n  function getDateValue(dataSelector) {\n    return function (data) {\n      var value = dataSelector(data);\n\n      if (value && !(value instanceof Date)) {\n        value = dateSerialization.deserializeDate(value);\n      }\n\n      return value;\n    };\n  }\n\n  function prepareFields(fields) {\n    each(fields || [], function (_, field) {\n      var fieldSelector;\n      var intervalSelector;\n      var dataField = field.dataField;\n      var groupInterval;\n      var levels = field.levels;\n      var dataSelector;\n\n      if (!field.selector) {\n        if (!dataField) {\n          dataSelector = function dataSelector(data) {\n            return data;\n          };\n        } else {\n          dataSelector = getDataSelector(dataField);\n        }\n\n        if (levels) {\n          prepareFields(levels);\n        }\n\n        if (\"date\" === field.dataType) {\n          intervalSelector = DATE_INTERVAL_SELECTORS[field.groupInterval];\n          var valueSelector = getDateValue(dataSelector);\n\n          fieldSelector = function fieldSelector(data) {\n            var value = valueSelector(data);\n            return intervalSelector ? intervalSelector(value) : value;\n          };\n        } else if (\"number\" === field.dataType) {\n          groupInterval = isNumeric(field.groupInterval) && field.groupInterval > 0 && field.groupInterval;\n\n          fieldSelector = function fieldSelector(data) {\n            var value = dataSelector(data);\n\n            if (isString(value)) {\n              value = Number(value);\n            }\n\n            return groupInterval ? Math.floor(value / groupInterval) * groupInterval : value;\n          };\n        } else {\n          fieldSelector = dataSelector;\n        }\n\n        setDefaultFieldValueFormatting(field);\n        setFieldProperty(field, \"selector\", fieldSelector);\n      }\n    });\n  }\n\n  function generateHierarchyItems(data, loadOptions, headers, headerName) {\n    var result = [0];\n    var expandIndex = loadOptions.headerName === headerName ? loadOptions.path.length : 0;\n    var expandedPaths = \"rows\" === headerName ? loadOptions.rowExpandedPaths : loadOptions.columnExpandedPaths;\n    var options = {\n      data: data,\n      childrenHash: headers[headerName + \"Hash\"],\n      dimensions: loadOptions[headerName],\n      expandedPathsHash: loadOptions.headerName !== headerName && expandedPaths && expandedPaths.hash\n    };\n    !function fillHierarchyItemIndexesCore(indexes, options, children, expandIndex, pathHash) {\n      var dimension = options.dimensions[expandIndex];\n      var expandedPathsHash = options.expandedPathsHash;\n      var dimensionValue;\n      var hierarchyItem;\n\n      if (dimension) {\n        dimensionValue = dimension.selector(options.data);\n        pathHash = void 0 !== pathHash ? pathHash + PATH_DELIMETER + dimensionValue : dimensionValue + \"\";\n\n        hierarchyItem = function (value, hierarchyItems, pathHash, childrenHash) {\n          var hierarchyItem = childrenHash[pathHash];\n\n          if (!hierarchyItem) {\n            hierarchyItem = {\n              value: value,\n              index: childrenHash.length++\n            };\n            childrenHash[pathHash] = hierarchyItem;\n            hierarchyItems.push(hierarchyItem);\n          }\n\n          return hierarchyItem;\n        }(dimensionValue, children, pathHash, options.childrenHash);\n\n        indexes.push(hierarchyItem.index);\n\n        if (expandedPathsHash && expandedPathsHash[pathHash] || dimension.expanded) {\n          if (!hierarchyItem.children) {\n            hierarchyItem.children = [];\n          }\n\n          fillHierarchyItemIndexesCore(indexes, options, hierarchyItem.children, expandIndex + 1, pathHash);\n        }\n      }\n    }(result, options, headers[headerName], expandIndex);\n    return result;\n  }\n\n  function generateAggregationCells(data, cells, headers, options) {\n    var cellSet = [];\n    var x;\n    var y;\n    var rowIndex;\n    var columnIndex;\n    var rowIndexes = generateHierarchyItems(data, options, headers, \"rows\");\n    var columnIndexes = generateHierarchyItems(data, options, headers, \"columns\");\n\n    for (y = 0; y < rowIndexes.length; y++) {\n      rowIndex = rowIndexes[y];\n      cells[rowIndex] = cells[rowIndex] || [];\n\n      for (x = 0; x < columnIndexes.length; x++) {\n        columnIndex = columnIndexes[x];\n        cellSet.push(cells[rowIndex][columnIndex] = cells[rowIndex][columnIndex] || []);\n      }\n    }\n\n    return cellSet;\n  }\n\n  function fillHashExpandedPath(expandedPaths) {\n    if (expandedPaths) {\n      var hash = expandedPaths.hash = {};\n      expandedPaths.forEach(function (path) {\n        var pathValue = path.map(function (value) {\n          return value + \"\";\n        }).join(PATH_DELIMETER);\n        hash[pathValue] = true;\n      });\n    }\n  }\n\n  function prepareLoadOption(options) {\n    options.rows = options.rows || [];\n    options.columns = options.columns || [];\n    options.filters = options.filters || [];\n    fillHashExpandedPath(options.columnExpandedPaths);\n    fillHashExpandedPath(options.rowExpandedPaths);\n    prepareFields(options.columns);\n    prepareFields(options.rows);\n    prepareFields(options.values);\n    prepareFields(options.filters);\n  }\n\n  function getAggregator(field) {\n    if (\"custom\" === field.summaryType) {\n      field.calculateCustomSummary = field.calculateCustomSummary || noop;\n      return {\n        seed: function seed() {\n          var options = {\n            summaryProcess: \"start\",\n            totalValue: void 0\n          };\n          field.calculateCustomSummary(options);\n          return options;\n        },\n        step: function step(options, value) {\n          options.summaryProcess = \"calculate\";\n          options.value = value;\n          field.calculateCustomSummary(options);\n          return options;\n        },\n        finalize: function finalize(options) {\n          options.summaryProcess = \"finalize\";\n          delete options.value;\n          field.calculateCustomSummary(options);\n          return options.totalValue;\n        }\n      };\n    }\n\n    return dataUtils.aggregators[field.summaryType] || dataUtils.aggregators.count;\n  }\n\n  function aggregationStep(measures, aggregationCells, data) {\n    for (var aggregatorIndex = 0; aggregatorIndex < measures.length; aggregatorIndex++) {\n      var cellField = measures[aggregatorIndex];\n      var cellValue = cellField.selector(data);\n      var aggregator = getAggregator(cellField);\n      var isAggregatorSeedFunction = \"function\" === typeof aggregator.seed;\n\n      for (var cellSetIndex = 0; cellSetIndex < aggregationCells.length; cellSetIndex++) {\n        var cell = aggregationCells[cellSetIndex];\n\n        if (cell.length <= aggregatorIndex) {\n          cell[aggregatorIndex] = isAggregatorSeedFunction ? aggregator.seed() : aggregator.seed;\n        }\n\n        if (void 0 === cell[aggregatorIndex]) {\n          cell[aggregatorIndex] = cellValue;\n        } else if (isDefined(cellValue)) {\n          cell[aggregatorIndex] = aggregator.step(cell[aggregatorIndex], cellValue);\n        }\n      }\n    }\n  }\n\n  function areValuesEqual(filterValue, fieldValue) {\n    var valueOfFilter = filterValue && filterValue.valueOf();\n    var valueOfField = fieldValue && fieldValue.valueOf();\n\n    if (Array.isArray(filterValue)) {\n      fieldValue = fieldValue || [];\n\n      for (var i = 0; i < filterValue.length; i++) {\n        valueOfFilter = filterValue[i] && filterValue[i].valueOf();\n        valueOfField = fieldValue[i] && fieldValue[i].valueOf();\n\n        if (valueOfFilter !== valueOfField) {\n          return false;\n        }\n      }\n\n      return true;\n    } else {\n      return valueOfFilter === valueOfField;\n    }\n  }\n\n  function createDimensionFilters(dimension) {\n    var filters = [];\n    each(dimension, function (_, field) {\n      var filterValues = field.filterValues || [];\n      var groupName = field.groupName;\n\n      if (groupName && isNumeric(field.groupIndex)) {\n        return;\n      }\n\n      filterValues.length && filters.push(function (dataItem) {\n        var value = field.levels ? function (levels, data) {\n          var value = [];\n          each(levels, function (_, field) {\n            value.push(field.selector(data));\n          });\n          return value;\n        }(field.levels, dataItem) : field.selector(dataItem);\n        var result = false;\n\n        for (var i = 0; i < filterValues.length; i++) {\n          if (areValuesEqual(filterValues[i], value)) {\n            result = true;\n            break;\n          }\n        }\n\n        return \"exclude\" === field.filterType ? !result : result;\n      });\n    });\n    return filters;\n  }\n\n  function createFilter(options) {\n    var filters = createDimensionFilters(options.rows).concat(createDimensionFilters(options.columns)).concat(createDimensionFilters(options.filters));\n    var expandedDimensions = options[options.headerName];\n    var path = options.path;\n\n    if (expandedDimensions) {\n      filters.push(function (dataItem) {\n        var expandValue;\n\n        for (var i = 0; i < path.length; i++) {\n          expandValue = expandedDimensions[i].selector(dataItem);\n\n          if (toComparable(expandValue, true) !== toComparable(path[i], true)) {\n            return false;\n          }\n        }\n\n        return true;\n      });\n    }\n\n    return function (dataItem) {\n      for (var i = 0; i < filters.length; i++) {\n        if (!filters[i](dataItem)) {\n          return false;\n        }\n      }\n\n      return true;\n    };\n  }\n\n  function loadCore(items, options, notifyProgress) {\n    var headers = {\n      columns: [],\n      rows: [],\n      columnsHash: {\n        length: 1\n      },\n      rowsHash: {\n        length: 1\n      }\n    };\n    var values = [];\n    var aggregationCells;\n    var data;\n    var d = new Deferred();\n    var i = 0;\n    var filter = createFilter(options);\n    !function processData() {\n      var t = new Date();\n      var startIndex = i;\n\n      for (; i < items.length; i++) {\n        if (i > startIndex && i % 1e4 === 0) {\n          if (new Date() - t >= 300) {\n            notifyProgress(i / items.length);\n            setTimeout(processData, 0);\n            return;\n          }\n        }\n\n        data = items[i];\n\n        if (filter(data)) {\n          aggregationCells = generateAggregationCells(data, values, headers, options);\n          aggregationStep(options.values, aggregationCells, data);\n        }\n      }\n\n      measures = options.values, cells = values, void each(measures, function (aggregatorIndex, cellField) {\n        var aggregator = getAggregator(cellField);\n\n        if (aggregator.finalize) {\n          each(cells, function (_, row) {\n            each(row, function (_, cell) {\n              if (cell && void 0 !== cell[aggregatorIndex]) {\n                cell[aggregatorIndex] = aggregator.finalize(cell[aggregatorIndex]);\n              }\n            });\n          });\n        }\n      });\n      var measures, cells;\n      notifyProgress(1);\n      d.resolve({\n        rows: headers.rows,\n        columns: headers.columns,\n        values: values,\n        grandTotalRowIndex: 0,\n        grandTotalColumnIndex: 0\n      });\n    }();\n    return d;\n  }\n\n  function filterDataSource(dataSource, fieldSelectors) {\n    var filter = dataSource.filter();\n\n    if (dataSource.store() instanceof CustomStore && filter) {\n      filter = processFilter(filter, fieldSelectors);\n      return dataQuery(dataSource.items()).filter(filter).toArray();\n    }\n\n    return dataSource.items();\n  }\n\n  function loadDataSource(dataSource, fieldSelectors, reload) {\n    var d = new Deferred();\n\n    var customizeStoreLoadOptionsHandler = function customizeStoreLoadOptionsHandler(options) {\n      if (dataSource.store() instanceof ArrayStore) {\n        options.storeLoadOptions.filter = processFilter(options.storeLoadOptions.filter, fieldSelectors);\n      }\n    };\n\n    dataSource.on(\"customizeStoreLoadOptions\", customizeStoreLoadOptionsHandler);\n\n    if (!dataSource.isLoaded() || reload) {\n      var loadDeferred = reload ? dataSource.load() : dataSource.reload();\n      when(loadDeferred).done(function () {\n        loadDataSource(dataSource, fieldSelectors).done(function () {\n          d.resolve(filterDataSource(dataSource, fieldSelectors));\n        }).fail(d.reject);\n      }).fail(d.reject);\n    } else {\n      d.resolve(filterDataSource(dataSource, fieldSelectors));\n    }\n\n    return d.always(function () {\n      dataSource.off(\"customizeStoreLoadOptions\", customizeStoreLoadOptionsHandler);\n    });\n  }\n\n  function fillSelectorsByFields(selectors, fields) {\n    fields.forEach(function (field) {\n      if (field.dataField && \"date\" === field.dataType) {\n        var valueSelector = getDateValue(getDataSelector(field.dataField));\n\n        selectors[field.dataField] = function (data) {\n          return valueSelector(data);\n        };\n      }\n    });\n  }\n\n  function getFieldSelectors(options) {\n    var selectors = {};\n\n    if (Array.isArray(options)) {\n      fillSelectorsByFields(selectors, options);\n    } else if (options) {\n      [\"rows\", \"columns\", \"filters\"].forEach(function (area) {\n        options[area] && fillSelectorsByFields(selectors, options[area]);\n      });\n    }\n\n    return selectors;\n  }\n\n  function processFilter(filter, fieldSelectors) {\n    if (!Array.isArray(filter)) {\n      return filter;\n    }\n\n    filter = filter.slice(0);\n\n    if (isString(filter[0]) && (filter[1] instanceof Date || filter[2] instanceof Date)) {\n      filter[0] = fieldSelectors[filter[0]];\n    }\n\n    for (var i = 0; i < filter.length; i++) {\n      filter[i] = processFilter(filter[i], fieldSelectors);\n    }\n\n    return filter;\n  }\n\n  return {\n    ctor: function ctor(options) {\n      this._progressChanged = options.onProgressChanged || noop;\n      this._dataSource = new DataSource(options);\n\n      this._dataSource.paginate(false);\n    },\n    getFields: function getFields(fields) {\n      var dataSource = this._dataSource;\n      var d = new Deferred();\n      loadDataSource(dataSource, getFieldSelectors(fields)).done(function (data) {\n        d.resolve(discoverObjectFields(data, fields));\n      }).fail(d.reject);\n      return d;\n    },\n    key: function key() {\n      return this._dataSource.key();\n    },\n    load: function load(options) {\n      var that = this;\n      var dataSource = that._dataSource;\n      var d = new Deferred();\n      prepareLoadOption(options);\n      loadDataSource(dataSource, getFieldSelectors(options), options.reload).done(function (data) {\n        when(loadCore(data, options, that._progressChanged)).done(d.resolve);\n      }).fail(d.reject);\n      return d;\n    },\n    filter: function filter() {\n      var dataSource = this._dataSource;\n      return dataSource.filter.apply(dataSource, arguments);\n    },\n    supportPaging: function supportPaging() {\n      return false;\n    },\n    getDrillDownItems: function getDrillDownItems(loadOptions, params) {\n      loadOptions = loadOptions || {};\n      params = params || {};\n      prepareLoadOption(loadOptions);\n      var drillDownItems = [];\n\n      var items = this._dataSource.items();\n\n      var item;\n      var maxRowCount = params.maxRowCount;\n      var customColumns = params.customColumns;\n      var filter = createFilter(loadOptions);\n      var pathFilter = createFilter({\n        rows: getFiltersByPath(loadOptions.rows, params.rowPath),\n        columns: getFiltersByPath(loadOptions.columns, params.columnPath),\n        filters: []\n      });\n\n      for (var i = 0; i < items.length; i++) {\n        if (pathFilter(items[i]) && filter(items[i])) {\n          if (customColumns) {\n            item = {};\n\n            for (var j = 0; j < customColumns.length; j++) {\n              item[customColumns[j]] = items[i][customColumns[j]];\n            }\n          } else {\n            item = items[i];\n          }\n\n          drillDownItems.push(item);\n        }\n\n        if (maxRowCount > 0 && drillDownItems.length === maxRowCount) {\n          break;\n        }\n      }\n\n      return drillDownItems;\n    }\n  };\n}()).include(storeDrillDownMixin);","map":{"version":3,"sources":["C:/Users/user/source/repos/ReportingPortal/6.3.0/angular/node_modules/devextreme/esm/ui/pivot_grid/local_store.js"],"names":["when","Deferred","dataUtils","dataQuery","dateSerialization","DataSource","CustomStore","compileGetter","toComparable","Class","noop","isNumeric","isDefined","isString","each","getFiltersByPath","setFieldProperty","setDefaultFieldValueFormatting","storeDrillDownMixin","discoverObjectFields","ArrayStore","PATH_DELIMETER","LocalStore","inherit","DATE_INTERVAL_SELECTORS","year","date","getFullYear","quarter","Math","floor","getMonth","month","day","getDate","dayOfWeek","getDay","getDataSelector","dataField","indexOf","data","getDateValue","dataSelector","value","Date","deserializeDate","prepareFields","fields","_","field","fieldSelector","intervalSelector","groupInterval","levels","selector","dataType","valueSelector","Number","generateHierarchyItems","loadOptions","headers","headerName","result","expandIndex","path","length","expandedPaths","rowExpandedPaths","columnExpandedPaths","options","childrenHash","dimensions","expandedPathsHash","hash","fillHierarchyItemIndexesCore","indexes","children","pathHash","dimension","dimensionValue","hierarchyItem","hierarchyItems","index","push","expanded","generateAggregationCells","cells","cellSet","x","y","rowIndex","columnIndex","rowIndexes","columnIndexes","fillHashExpandedPath","forEach","pathValue","map","join","prepareLoadOption","rows","columns","filters","values","getAggregator","summaryType","calculateCustomSummary","seed","summaryProcess","totalValue","step","finalize","aggregators","count","aggregationStep","measures","aggregationCells","aggregatorIndex","cellField","cellValue","aggregator","isAggregatorSeedFunction","cellSetIndex","cell","areValuesEqual","filterValue","fieldValue","valueOfFilter","valueOf","valueOfField","Array","isArray","i","createDimensionFilters","filterValues","groupName","groupIndex","dataItem","filterType","createFilter","concat","expandedDimensions","expandValue","loadCore","items","notifyProgress","columnsHash","rowsHash","d","filter","processData","t","startIndex","setTimeout","row","resolve","grandTotalRowIndex","grandTotalColumnIndex","filterDataSource","dataSource","fieldSelectors","store","processFilter","toArray","loadDataSource","reload","customizeStoreLoadOptionsHandler","storeLoadOptions","on","isLoaded","loadDeferred","load","done","fail","reject","always","off","fillSelectorsByFields","selectors","getFieldSelectors","area","slice","ctor","_progressChanged","onProgressChanged","_dataSource","paginate","getFields","key","that","apply","arguments","supportPaging","getDrillDownItems","params","drillDownItems","item","maxRowCount","customColumns","pathFilter","rowPath","columnPath","j","include"],"mappings":"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","sourcesContent":["/**\r\n * DevExtreme (esm/ui/pivot_grid/local_store.js)\r\n * Version: 21.1.3\r\n * Build date: Tue May 18 2021\r\n *\r\n * Copyright (c) 2012 - 2021 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\r\nimport {\r\n    when,\r\n    Deferred\r\n} from \"../../core/utils/deferred\";\r\nimport dataUtils from \"../../data/utils\";\r\nimport dataQuery from \"../../data/query\";\r\nimport dateSerialization from \"../../core/utils/date_serialization\";\r\nimport {\r\n    DataSource\r\n} from \"../../data/data_source/data_source\";\r\nimport CustomStore from \"../../data/custom_store\";\r\nimport {\r\n    compileGetter,\r\n    toComparable\r\n} from \"../../core/utils/data\";\r\nimport Class from \"../../core/class\";\r\nimport {\r\n    noop\r\n} from \"../../core/utils/common\";\r\nimport {\r\n    isNumeric,\r\n    isDefined,\r\n    isString\r\n} from \"../../core/utils/type\";\r\nimport {\r\n    each\r\n} from \"../../core/utils/iterator\";\r\nimport {\r\n    getFiltersByPath,\r\n    setFieldProperty,\r\n    setDefaultFieldValueFormatting,\r\n    storeDrillDownMixin,\r\n    discoverObjectFields\r\n} from \"./ui.pivot_grid.utils\";\r\nimport ArrayStore from \"../../data/array_store\";\r\nvar PATH_DELIMETER = \"/./\";\r\nexport var LocalStore = Class.inherit(function() {\r\n    var DATE_INTERVAL_SELECTORS = {\r\n        year: function(date) {\r\n            return date && date.getFullYear()\r\n        },\r\n        quarter: function(date) {\r\n            return date && Math.floor(date.getMonth() / 3) + 1\r\n        },\r\n        month: function(date) {\r\n            return date && date.getMonth() + 1\r\n        },\r\n        day: function(date) {\r\n            return date && date.getDate()\r\n        },\r\n        dayOfWeek: function(date) {\r\n            return date && date.getDay()\r\n        }\r\n    };\r\n\r\n    function getDataSelector(dataField) {\r\n        return -1 !== dataField.indexOf(\".\") ? compileGetter(dataField) : function(data) {\r\n            return data[dataField]\r\n        }\r\n    }\r\n\r\n    function getDateValue(dataSelector) {\r\n        return function(data) {\r\n            var value = dataSelector(data);\r\n            if (value && !(value instanceof Date)) {\r\n                value = dateSerialization.deserializeDate(value)\r\n            }\r\n            return value\r\n        }\r\n    }\r\n\r\n    function prepareFields(fields) {\r\n        each(fields || [], (function(_, field) {\r\n            var fieldSelector;\r\n            var intervalSelector;\r\n            var dataField = field.dataField;\r\n            var groupInterval;\r\n            var levels = field.levels;\r\n            var dataSelector;\r\n            if (!field.selector) {\r\n                if (!dataField) {\r\n                    dataSelector = function(data) {\r\n                        return data\r\n                    }\r\n                } else {\r\n                    dataSelector = getDataSelector(dataField)\r\n                }\r\n                if (levels) {\r\n                    prepareFields(levels)\r\n                }\r\n                if (\"date\" === field.dataType) {\r\n                    intervalSelector = DATE_INTERVAL_SELECTORS[field.groupInterval];\r\n                    var valueSelector = getDateValue(dataSelector);\r\n                    fieldSelector = function(data) {\r\n                        var value = valueSelector(data);\r\n                        return intervalSelector ? intervalSelector(value) : value\r\n                    }\r\n                } else if (\"number\" === field.dataType) {\r\n                    groupInterval = isNumeric(field.groupInterval) && field.groupInterval > 0 && field.groupInterval;\r\n                    fieldSelector = function(data) {\r\n                        var value = dataSelector(data);\r\n                        if (isString(value)) {\r\n                            value = Number(value)\r\n                        }\r\n                        return groupInterval ? Math.floor(value / groupInterval) * groupInterval : value\r\n                    }\r\n                } else {\r\n                    fieldSelector = dataSelector\r\n                }\r\n                setDefaultFieldValueFormatting(field);\r\n                setFieldProperty(field, \"selector\", fieldSelector)\r\n            }\r\n        }))\r\n    }\r\n\r\n    function generateHierarchyItems(data, loadOptions, headers, headerName) {\r\n        var result = [0];\r\n        var expandIndex = loadOptions.headerName === headerName ? loadOptions.path.length : 0;\r\n        var expandedPaths = \"rows\" === headerName ? loadOptions.rowExpandedPaths : loadOptions.columnExpandedPaths;\r\n        var options = {\r\n            data: data,\r\n            childrenHash: headers[headerName + \"Hash\"],\r\n            dimensions: loadOptions[headerName],\r\n            expandedPathsHash: loadOptions.headerName !== headerName && expandedPaths && expandedPaths.hash\r\n        };\r\n        ! function fillHierarchyItemIndexesCore(indexes, options, children, expandIndex, pathHash) {\r\n            var dimension = options.dimensions[expandIndex];\r\n            var expandedPathsHash = options.expandedPathsHash;\r\n            var dimensionValue;\r\n            var hierarchyItem;\r\n            if (dimension) {\r\n                dimensionValue = dimension.selector(options.data);\r\n                pathHash = void 0 !== pathHash ? pathHash + PATH_DELIMETER + dimensionValue : dimensionValue + \"\";\r\n                hierarchyItem = function(value, hierarchyItems, pathHash, childrenHash) {\r\n                    var hierarchyItem = childrenHash[pathHash];\r\n                    if (!hierarchyItem) {\r\n                        hierarchyItem = {\r\n                            value: value,\r\n                            index: childrenHash.length++\r\n                        };\r\n                        childrenHash[pathHash] = hierarchyItem;\r\n                        hierarchyItems.push(hierarchyItem)\r\n                    }\r\n                    return hierarchyItem\r\n                }(dimensionValue, children, pathHash, options.childrenHash);\r\n                indexes.push(hierarchyItem.index);\r\n                if (expandedPathsHash && expandedPathsHash[pathHash] || dimension.expanded) {\r\n                    if (!hierarchyItem.children) {\r\n                        hierarchyItem.children = []\r\n                    }\r\n                    fillHierarchyItemIndexesCore(indexes, options, hierarchyItem.children, expandIndex + 1, pathHash)\r\n                }\r\n            }\r\n        }(result, options, headers[headerName], expandIndex);\r\n        return result\r\n    }\r\n\r\n    function generateAggregationCells(data, cells, headers, options) {\r\n        var cellSet = [];\r\n        var x;\r\n        var y;\r\n        var rowIndex;\r\n        var columnIndex;\r\n        var rowIndexes = generateHierarchyItems(data, options, headers, \"rows\");\r\n        var columnIndexes = generateHierarchyItems(data, options, headers, \"columns\");\r\n        for (y = 0; y < rowIndexes.length; y++) {\r\n            rowIndex = rowIndexes[y];\r\n            cells[rowIndex] = cells[rowIndex] || [];\r\n            for (x = 0; x < columnIndexes.length; x++) {\r\n                columnIndex = columnIndexes[x];\r\n                cellSet.push(cells[rowIndex][columnIndex] = cells[rowIndex][columnIndex] || [])\r\n            }\r\n        }\r\n        return cellSet\r\n    }\r\n\r\n    function fillHashExpandedPath(expandedPaths) {\r\n        if (expandedPaths) {\r\n            var hash = expandedPaths.hash = {};\r\n            expandedPaths.forEach((function(path) {\r\n                var pathValue = path.map((function(value) {\r\n                    return value + \"\"\r\n                })).join(PATH_DELIMETER);\r\n                hash[pathValue] = true\r\n            }))\r\n        }\r\n    }\r\n\r\n    function prepareLoadOption(options) {\r\n        options.rows = options.rows || [];\r\n        options.columns = options.columns || [];\r\n        options.filters = options.filters || [];\r\n        fillHashExpandedPath(options.columnExpandedPaths);\r\n        fillHashExpandedPath(options.rowExpandedPaths);\r\n        prepareFields(options.columns);\r\n        prepareFields(options.rows);\r\n        prepareFields(options.values);\r\n        prepareFields(options.filters)\r\n    }\r\n\r\n    function getAggregator(field) {\r\n        if (\"custom\" === field.summaryType) {\r\n            field.calculateCustomSummary = field.calculateCustomSummary || noop;\r\n            return {\r\n                seed: function() {\r\n                    var options = {\r\n                        summaryProcess: \"start\",\r\n                        totalValue: void 0\r\n                    };\r\n                    field.calculateCustomSummary(options);\r\n                    return options\r\n                },\r\n                step: function(options, value) {\r\n                    options.summaryProcess = \"calculate\";\r\n                    options.value = value;\r\n                    field.calculateCustomSummary(options);\r\n                    return options\r\n                },\r\n                finalize: function(options) {\r\n                    options.summaryProcess = \"finalize\";\r\n                    delete options.value;\r\n                    field.calculateCustomSummary(options);\r\n                    return options.totalValue\r\n                }\r\n            }\r\n        }\r\n        return dataUtils.aggregators[field.summaryType] || dataUtils.aggregators.count\r\n    }\r\n\r\n    function aggregationStep(measures, aggregationCells, data) {\r\n        for (var aggregatorIndex = 0; aggregatorIndex < measures.length; aggregatorIndex++) {\r\n            var cellField = measures[aggregatorIndex];\r\n            var cellValue = cellField.selector(data);\r\n            var aggregator = getAggregator(cellField);\r\n            var isAggregatorSeedFunction = \"function\" === typeof aggregator.seed;\r\n            for (var cellSetIndex = 0; cellSetIndex < aggregationCells.length; cellSetIndex++) {\r\n                var cell = aggregationCells[cellSetIndex];\r\n                if (cell.length <= aggregatorIndex) {\r\n                    cell[aggregatorIndex] = isAggregatorSeedFunction ? aggregator.seed() : aggregator.seed\r\n                }\r\n                if (void 0 === cell[aggregatorIndex]) {\r\n                    cell[aggregatorIndex] = cellValue\r\n                } else if (isDefined(cellValue)) {\r\n                    cell[aggregatorIndex] = aggregator.step(cell[aggregatorIndex], cellValue)\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function areValuesEqual(filterValue, fieldValue) {\r\n        var valueOfFilter = filterValue && filterValue.valueOf();\r\n        var valueOfField = fieldValue && fieldValue.valueOf();\r\n        if (Array.isArray(filterValue)) {\r\n            fieldValue = fieldValue || [];\r\n            for (var i = 0; i < filterValue.length; i++) {\r\n                valueOfFilter = filterValue[i] && filterValue[i].valueOf();\r\n                valueOfField = fieldValue[i] && fieldValue[i].valueOf();\r\n                if (valueOfFilter !== valueOfField) {\r\n                    return false\r\n                }\r\n            }\r\n            return true\r\n        } else {\r\n            return valueOfFilter === valueOfField\r\n        }\r\n    }\r\n\r\n    function createDimensionFilters(dimension) {\r\n        var filters = [];\r\n        each(dimension, (function(_, field) {\r\n            var filterValues = field.filterValues || [];\r\n            var groupName = field.groupName;\r\n            if (groupName && isNumeric(field.groupIndex)) {\r\n                return\r\n            }\r\n            filterValues.length && filters.push((function(dataItem) {\r\n                var value = field.levels ? function(levels, data) {\r\n                    var value = [];\r\n                    each(levels, (function(_, field) {\r\n                        value.push(field.selector(data))\r\n                    }));\r\n                    return value\r\n                }(field.levels, dataItem) : field.selector(dataItem);\r\n                var result = false;\r\n                for (var i = 0; i < filterValues.length; i++) {\r\n                    if (areValuesEqual(filterValues[i], value)) {\r\n                        result = true;\r\n                        break\r\n                    }\r\n                }\r\n                return \"exclude\" === field.filterType ? !result : result\r\n            }))\r\n        }));\r\n        return filters\r\n    }\r\n\r\n    function createFilter(options) {\r\n        var filters = createDimensionFilters(options.rows).concat(createDimensionFilters(options.columns)).concat(createDimensionFilters(options.filters));\r\n        var expandedDimensions = options[options.headerName];\r\n        var path = options.path;\r\n        if (expandedDimensions) {\r\n            filters.push((function(dataItem) {\r\n                var expandValue;\r\n                for (var i = 0; i < path.length; i++) {\r\n                    expandValue = expandedDimensions[i].selector(dataItem);\r\n                    if (toComparable(expandValue, true) !== toComparable(path[i], true)) {\r\n                        return false\r\n                    }\r\n                }\r\n                return true\r\n            }))\r\n        }\r\n        return function(dataItem) {\r\n            for (var i = 0; i < filters.length; i++) {\r\n                if (!filters[i](dataItem)) {\r\n                    return false\r\n                }\r\n            }\r\n            return true\r\n        }\r\n    }\r\n\r\n    function loadCore(items, options, notifyProgress) {\r\n        var headers = {\r\n            columns: [],\r\n            rows: [],\r\n            columnsHash: {\r\n                length: 1\r\n            },\r\n            rowsHash: {\r\n                length: 1\r\n            }\r\n        };\r\n        var values = [];\r\n        var aggregationCells;\r\n        var data;\r\n        var d = new Deferred;\r\n        var i = 0;\r\n        var filter = createFilter(options);\r\n        ! function processData() {\r\n            var t = new Date;\r\n            var startIndex = i;\r\n            for (; i < items.length; i++) {\r\n                if (i > startIndex && i % 1e4 === 0) {\r\n                    if (new Date - t >= 300) {\r\n                        notifyProgress(i / items.length);\r\n                        setTimeout(processData, 0);\r\n                        return\r\n                    }\r\n                }\r\n                data = items[i];\r\n                if (filter(data)) {\r\n                    aggregationCells = generateAggregationCells(data, values, headers, options);\r\n                    aggregationStep(options.values, aggregationCells, data)\r\n                }\r\n            }\r\n            measures = options.values, cells = values, void each(measures, (function(aggregatorIndex, cellField) {\r\n                var aggregator = getAggregator(cellField);\r\n                if (aggregator.finalize) {\r\n                    each(cells, (function(_, row) {\r\n                        each(row, (function(_, cell) {\r\n                            if (cell && void 0 !== cell[aggregatorIndex]) {\r\n                                cell[aggregatorIndex] = aggregator.finalize(cell[aggregatorIndex])\r\n                            }\r\n                        }))\r\n                    }))\r\n                }\r\n            }));\r\n            var measures, cells;\r\n            notifyProgress(1);\r\n            d.resolve({\r\n                rows: headers.rows,\r\n                columns: headers.columns,\r\n                values: values,\r\n                grandTotalRowIndex: 0,\r\n                grandTotalColumnIndex: 0\r\n            })\r\n        }();\r\n        return d\r\n    }\r\n\r\n    function filterDataSource(dataSource, fieldSelectors) {\r\n        var filter = dataSource.filter();\r\n        if (dataSource.store() instanceof CustomStore && filter) {\r\n            filter = processFilter(filter, fieldSelectors);\r\n            return dataQuery(dataSource.items()).filter(filter).toArray()\r\n        }\r\n        return dataSource.items()\r\n    }\r\n\r\n    function loadDataSource(dataSource, fieldSelectors, reload) {\r\n        var d = new Deferred;\r\n        var customizeStoreLoadOptionsHandler = function(options) {\r\n            if (dataSource.store() instanceof ArrayStore) {\r\n                options.storeLoadOptions.filter = processFilter(options.storeLoadOptions.filter, fieldSelectors)\r\n            }\r\n        };\r\n        dataSource.on(\"customizeStoreLoadOptions\", customizeStoreLoadOptionsHandler);\r\n        if (!dataSource.isLoaded() || reload) {\r\n            var loadDeferred = reload ? dataSource.load() : dataSource.reload();\r\n            when(loadDeferred).done((function() {\r\n                loadDataSource(dataSource, fieldSelectors).done((function() {\r\n                    d.resolve(filterDataSource(dataSource, fieldSelectors))\r\n                })).fail(d.reject)\r\n            })).fail(d.reject)\r\n        } else {\r\n            d.resolve(filterDataSource(dataSource, fieldSelectors))\r\n        }\r\n        return d.always((function() {\r\n            dataSource.off(\"customizeStoreLoadOptions\", customizeStoreLoadOptionsHandler)\r\n        }))\r\n    }\r\n\r\n    function fillSelectorsByFields(selectors, fields) {\r\n        fields.forEach((function(field) {\r\n            if (field.dataField && \"date\" === field.dataType) {\r\n                var valueSelector = getDateValue(getDataSelector(field.dataField));\r\n                selectors[field.dataField] = function(data) {\r\n                    return valueSelector(data)\r\n                }\r\n            }\r\n        }))\r\n    }\r\n\r\n    function getFieldSelectors(options) {\r\n        var selectors = {};\r\n        if (Array.isArray(options)) {\r\n            fillSelectorsByFields(selectors, options)\r\n        } else if (options) {\r\n            [\"rows\", \"columns\", \"filters\"].forEach((function(area) {\r\n                options[area] && fillSelectorsByFields(selectors, options[area])\r\n            }))\r\n        }\r\n        return selectors\r\n    }\r\n\r\n    function processFilter(filter, fieldSelectors) {\r\n        if (!Array.isArray(filter)) {\r\n            return filter\r\n        }\r\n        filter = filter.slice(0);\r\n        if (isString(filter[0]) && (filter[1] instanceof Date || filter[2] instanceof Date)) {\r\n            filter[0] = fieldSelectors[filter[0]]\r\n        }\r\n        for (var i = 0; i < filter.length; i++) {\r\n            filter[i] = processFilter(filter[i], fieldSelectors)\r\n        }\r\n        return filter\r\n    }\r\n    return {\r\n        ctor: function(options) {\r\n            this._progressChanged = options.onProgressChanged || noop;\r\n            this._dataSource = new DataSource(options);\r\n            this._dataSource.paginate(false)\r\n        },\r\n        getFields: function(fields) {\r\n            var dataSource = this._dataSource;\r\n            var d = new Deferred;\r\n            loadDataSource(dataSource, getFieldSelectors(fields)).done((function(data) {\r\n                d.resolve(discoverObjectFields(data, fields))\r\n            })).fail(d.reject);\r\n            return d\r\n        },\r\n        key: function() {\r\n            return this._dataSource.key()\r\n        },\r\n        load: function(options) {\r\n            var that = this;\r\n            var dataSource = that._dataSource;\r\n            var d = new Deferred;\r\n            prepareLoadOption(options);\r\n            loadDataSource(dataSource, getFieldSelectors(options), options.reload).done((function(data) {\r\n                when(loadCore(data, options, that._progressChanged)).done(d.resolve)\r\n            })).fail(d.reject);\r\n            return d\r\n        },\r\n        filter: function() {\r\n            var dataSource = this._dataSource;\r\n            return dataSource.filter.apply(dataSource, arguments)\r\n        },\r\n        supportPaging: function() {\r\n            return false\r\n        },\r\n        getDrillDownItems: function(loadOptions, params) {\r\n            loadOptions = loadOptions || {};\r\n            params = params || {};\r\n            prepareLoadOption(loadOptions);\r\n            var drillDownItems = [];\r\n            var items = this._dataSource.items();\r\n            var item;\r\n            var maxRowCount = params.maxRowCount;\r\n            var customColumns = params.customColumns;\r\n            var filter = createFilter(loadOptions);\r\n            var pathFilter = createFilter({\r\n                rows: getFiltersByPath(loadOptions.rows, params.rowPath),\r\n                columns: getFiltersByPath(loadOptions.columns, params.columnPath),\r\n                filters: []\r\n            });\r\n            for (var i = 0; i < items.length; i++) {\r\n                if (pathFilter(items[i]) && filter(items[i])) {\r\n                    if (customColumns) {\r\n                        item = {};\r\n                        for (var j = 0; j < customColumns.length; j++) {\r\n                            item[customColumns[j]] = items[i][customColumns[j]]\r\n                        }\r\n                    } else {\r\n                        item = items[i]\r\n                    }\r\n                    drillDownItems.push(item)\r\n                }\r\n                if (maxRowCount > 0 && drillDownItems.length === maxRowCount) {\r\n                    break\r\n                }\r\n            }\r\n            return drillDownItems\r\n        }\r\n    }\r\n}()).include(storeDrillDownMixin);\r\n"]},"metadata":{},"sourceType":"module"}